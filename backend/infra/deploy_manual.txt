ИНСТРУКЦИЯ ПО РУЧНОМУ ДЕПЛОЮ НА СЕРВЕР

Данные для подключения:
- IP-адрес: 194.32.142.196
- Пользователь: ubuntu
- Пароль: N+ClxHm79aStK/7IbKIy0to=

ШАГ 1: ПОДКЛЮЧЕНИЕ К СЕРВЕРУ
ssh ubuntu@194.32.142.196

ШАГ 2: УСТАНОВКА НЕОБХОДИМЫХ ПАКЕТОВ
sudo apt-get update
sudo apt-get install -y docker.io docker-compose git

# Добавление пользователя в группу docker
sudo usermod -aG docker ubuntu
newgrp docker

ШАГ 3: КОПИРОВАНИЕ ПРОЕКТА НА СЕРВЕР

На локальной машине:
cd backend
tar --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='*.db' --exclude='.git' -czf dictionary-backend.tar.gz .
scp dictionary-backend.tar.gz ubuntu@194.32.142.196:/tmp/

На сервере:
sudo mkdir -p /opt/dictionary-backend
sudo chown -R ubuntu:ubuntu /opt/dictionary-backend
cd /opt/dictionary-backend
tar -xzf /tmp/dictionary-backend.tar.gz
rm /tmp/dictionary-backend.tar.gz

ШАГ 4: НАСТРОЙКА ПЕРЕМЕННЫХ ОКРУЖЕНИЯ
cd /opt/dictionary-backend/infra
echo "SECRET_KEY=$(openssl rand -hex 32)" > .env

ШАГ 5: СОЗДАНИЕ ДИРЕКТОРИЙ ДЛЯ ДАННЫХ
mkdir -p data/auth data/dictionary data/search data/import_export data/admin

ШАГ 6: ЗАПУСК СЕРВИСОВ
docker-compose -f compose.prod.yml build
docker-compose -f compose.prod.yml up -d

ШАГ 7: ПРОВЕРКА СТАТУСА
docker-compose -f compose.prod.yml ps
docker-compose -f compose.prod.yml logs -f

ШАГ 8: ПРОВЕРКА РАБОТОСПОСОБНОСТИ
curl http://localhost/health
curl http://localhost:8001/health
curl http://localhost:8002/health
curl http://localhost:8003/health
curl http://localhost:8004/health
curl http://localhost:8005/health

ПОЛЕЗНЫЕ КОМАНДЫ:

Просмотр логов:
docker-compose -f compose.prod.yml logs -f [service_name]

Остановка сервисов:
docker-compose -f compose.prod.yml down

Перезапуск сервисов:
docker-compose -f compose.prod.yml restart

Обновление после изменений:
cd /opt/dictionary-backend/infra
docker-compose -f compose.prod.yml down
docker-compose -f compose.prod.yml build --no-cache
docker-compose -f compose.prod.yml up -d

Очистка неиспользуемых образов:
docker system prune -a

НАСТРОЙКА ФАЙРВОЛА (если необходимо):

Открытие портов:
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

НАСТРОЙКА NGINX ДЛЯ SSL (опционально):

1. Установка certbot:
sudo apt-get install -y certbot python3-certbot-nginx

2. Получение сертификата:
sudo certbot --nginx -d your-domain.com

3. Автоматическое обновление:
sudo certbot renew --dry-run

ПРОБЛЕМЫ И РЕШЕНИЯ:

1. Порт уже занят:
   - Проверьте: sudo netstat -tulpn | grep :80
   - Остановите конфликтующий сервис или измените порт в compose.prod.yml

2. Ошибки прав доступа:
   - Убедитесь что пользователь в группе docker: groups
   - Перезапустите сессию: newgrp docker

3. Ошибки сборки Docker:
   - Проверьте логи: docker-compose -f compose.prod.yml build --no-cache
   - Убедитесь что все зависимости в requirements.txt

4. База данных не создается:
   - Проверьте права на директорию data: ls -la data/
   - Убедитесь что директория существует и доступна для записи
